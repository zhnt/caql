# AQL解析器结构体关系图

## 1. 核心结构体层次关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          AQL Parser Architecture                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌─────────────────────────┐                                          │
│  │    LexState (alex)      │◄────────────────────┐                   │
│  │   词法分析器状态        │                     │                   │
│  └──────────┬──────────────┘                     │                   │
│             │                                    │                   │
│             │                                    │                   │
│  ┌──────────┴──────────────┐                     │                   │
│  │    FuncState (aparser)  │◄──────────────────┐│                   │
│  │   函数状态管理          │                   ││                   │
│  └──────────┬──────────────┘                   ││                   │
│             │                                  ││                   │
│             │ 1:N                              ││                   │
│  ┌──────────┴──────────────┐                   ││                   │
│  │    AExpDesc             │◄─────────────────┐││                   │
│  │   表达式描述符          │                  │││                   │
│  └──────────┬──────────────┘                  │││                   │
│             │                                  │││                   │
│             │                                  │││                   │
│  ┌──────────┴──────────────┐                  │││                   │
│  │    ABlockCnt            │◄────────────────┐│││                   │
│  │   块控制结构            │                 ││││                   │
│  └──────────┬──────────────┘                 ││││                   │
│             │                                ││││                   │
│             │                                ││││                   │
│  ┌──────────┴──────────────┐                │││││                   │
│  │    ADyndata             │◄──────────────┐│││││                   │
│  │   动态数据结构          │               ││││││                   │
│  └─────────────────────────┘               ││││││                   │
│                                            ││││││                   │
│  ┌─────────────────────────┐               ││││││                   │
│  │    AVardesc             │───────────────┘│││││                   │
│  │   变量描述符            │                │││││                   │
│  └─────────────────────────┘                │││││                   │
│                                             │││││                   │
│  ┌─────────────────────────┐                │││││                   │
│  │    ALabeldesc           │────────────────┘││││                   │
│  │   标签描述符            │                 ││││                   │
│  └─────────────────────────┘                 ││││                   │
│                                              ││││                   │
│  ┌─────────────────────────┐                 ││││                   │
│  │    ALabellist           │─────────────────┘│││                   │
│  │   标签列表              │                  │││                   │
│  └─────────────────────────┘                  │││                   │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. 详细结构体关系图

### 2.1 FuncState与其他结构体的关系

```
                        FuncState (AFuncState)
                              │
                 ┌────────────┼────────────┐
                 │            │            │
                 │            │            │
                 ▼            ▼            ▼
             AProto      AFuncState*    ALexState
           (函数原型)      (外围函数)    (词法状态)
                 │            │            │
                 │            │            │
                 └────────────┼────────────┘
                              │
                 ┌────────────┼────────────┐
                 │            │            │
                 ▼            ▼            ▼
            ABlockCnt*    ADyndata*     int (寄存器)
           (当前块链)    (动态数据)    (计数器)
```

### 2.2 表达式描述符层次结构

```
                        AExpDesc
                           │
            ┌──────────────┼──────────────┐
            │              │              │
            ▼              ▼              ▼
        AExpKind        union u       int t/f
      (表达式类型)     (联合数据)    (跳转列表)
                           │
            ┌──────────────┼──────────────┐
            │              │              │
            ▼              ▼              ▼
       aql_Integer    aql_Number    TString*
       (整型常量)     (浮点常量)    (字符串)
                           │
            ┌──────────────┼──────────────┐
            │              │              │
            ▼              ▼              ▼
         struct ind     struct var      int info
       (索引变量)     (局部变量)    (通用信息)
```

### 2.3 块控制结构的嵌套关系

```
                        ABlockCnt
                           │
                 ┌─────────┼─────────┐
                 │         │         │
                 ▼         ▼         ▼
            ABlockCnt*   int       aql_byte
          (前一个块)   (索引)    (标志位)
                 │         │         │
                 │         │         │
                 └─────────┼─────────┘
                           │
                 ┌─────────┼─────────┐
                 │         │         │
                 ▼         ▼         ▼
            firstlabel firstgoto nactvar
          (标签索引) (goto索引) (变量计数)
```

### 2.4 动态数据结构关系

```
                        ADyndata
                           │
                 ┌─────────┼─────────┐
                 │         │         │
                 ▼         ▼         ▼
            struct      ALabellist ALabellist
          (活跃变量)     (goto列表) (标签列表)
                 │         │         │
                 │         │         │
                 └─────────┼─────────┘
                           │
                 ┌─────────┼─────────┐
                 │         │         │
                 ▼         ▼         ▼
            AVardesc*   int n     int size
          (变量数组)   (使用数)  (数组大小)
```

## 3. 内存布局图

### 3.1 栈式寄存器分配

```
┌─────────────────────────────────────────┐
│              FuncState                  │
│  ┌─────────────────────────────────────┐ │
│  │             寄存器布局                │ │
│  │  ┌─────────┬─────────────────────┐  │ │
│  │  │ 索引0   │ 全局变量/常量        │  │ │
│  │  ├─────────┼─────────────────────┤  │ │
│  │  │ 索引1   │ 局部变量1            │  │ │
│  │  ├─────────┼─────────────────────┤  │ │
│  │  │ 索引2   │ 局部变量2            │  │ │
│  │  ├─────────┼─────────────────────┤  │ │
│  │  │ ...     │ ...                 │  │ │
│  │  ├─────────┼─────────────────────┤  │ │
│  │  │ 索引n-1 │ 最后一个局部变量     │  │ │
│  │  ├─────────┼─────────────────────┤  │ │
│  │  │ 索引n   │ 第一个空闲寄存器     │  │ │
│  │  └─────────┴─────────────────────┘  │ │
│  │         ▲                           │ │
│  │         │                           │ │
│  │  freereg┘                           │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 3.2 作用域链结构

```
┌─────────────────────────────────────────┐
│              作用域链                   │
│  ┌─────────────────────────────────────┐ │
│  │  BlockCnt 0 (最外层)                │ │
│  │  ┌─────────┬─────────────────────┐ │ │
│  │  │previous │ NULL                │ │ │
│  │  │nactvar  │ 0                   │ │ │
│  │  │isloop   │ 0                   │ │ │
│  │  └─────────┴─────────────────────┘ │ │
│  │           │                         │ │
│  │           ▼                         │ │
│  │  BlockCnt 1 (函数体)               │ │
│  │  ┌─────────┬─────────────────────┐ │ │
│  │  │previous │ ────────┐           │ │
│  │  │nactvar  │ 3       │           │ │
│  │  │isloop   │ 0       │           │ │
│  │  └─────────┴─────────┘           │ │
│  │           │                       │ │
│  │           ▼                       │ │
│  │  BlockCnt 2 (if语句)             │ │
│  │  ┌─────────┬─────────────────────┐ │ │
│  │  │previous │ ────────┐           │ │
│  │  │nactvar  │ 5       │           │ │
│  │  │isloop   │ 0       │           │ │
│  │  └─────────┴─────────┘           │ │
│  │           │                       │ │
│  │           ▼                       │ │
│  │  BlockCnt 3 (while循环)          │ │
│  │  ┌─────────┬─────────────────────┐ │ │
│  │  │previous │ ────────┐           │ │
│  │  │nactvar  │ 7       │           │ │
│  │  │isloop   │ 1       │           │ │
│  │  └─────────┴─────────┘           │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

## 4. 运行时数据流图

### 4.1 解析流程图

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   aqlY_parser  │────▶│ aqlY_mainfunc │────▶│ aqlY_statlist │
│   (主入口)    │     │ (主函数)    │     │ (语句列表)  │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 初始化词法   │     │ 设置环境    │     │ 循环解析    │
│ 状态        │     │ upvalue     │     │ 语句        │
└─────────────┘     └─────────────┘     └─────────────┘
```

### 4.2 表达式求值流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   aqlY_expr   │────▶│ aqlY_subexpr  │────▶│   优先级   │
│   (表达式)    │     │ (子表达式)  │     │   解析    │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 生成字节码   │     │ 处理一元    │     │ 处理二元    │
│             │     │ 运算符      │     │ 运算符      │
└─────────────┘     └─────────────┘     └─────────────┘
```

## 5. 结构体字段映射关系

### 5.1 Lua → AQL 类型映射

```
Lua lparser.h          AQL aparser.h           用途
────────────────────────────────────────────────────
expdesc               AExpDesc              表达式描述
Vardesc               AVardesc              变量描述
Labeldesc             ALabeldesc            标签描述
Labellist             ALabellist            标签列表
Dyndata               ADyndata              动态数据
FuncState             AFuncState            函数状态
BlockCnt              ABlockCnt             块控制

lua_Integer           aql_Integer           整型
lua_Number            aql_Number            浮点型
lu_byte               aql_byte              字节型
TString               TString               字符串
TValue                TValue                通用值
```

## 6. 总结

这些结构体形成了AQL解析器的核心架构，完全基于Lua 5.4的设计但使用AQL的类型系统。主要特点：

1. **层次化设计**：从词法状态到函数状态到表达式描述的清晰层次
2. **栈式管理**：使用寄存器栈管理局部变量和临时表达式
3. **作用域链**：通过BlockCnt链管理嵌套作用域
4. **类型兼容**：所有类型与现有AQL代码库100%兼容
5. **内存高效**：紧凑的结构体设计，最小化内存使用