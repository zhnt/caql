# AQL GC指令参考文档

## 概述

AQL虚拟机现已集成完整的GC相关指令集，支持现代垃圾回收功能，包括写屏障、引用计数管理、弱引用等高级特性。

## GC指令列表

### 1. 写屏障指令

#### `OP_GC_WRITE_BARRIER`
- **语法**: `GC_WRITE_BARRIER A B`
- **功能**: 执行GC写屏障，记录对象间引用关系
- **操作**: `WriteBarrier(R(A), R(B))`
- **说明**: 当R(A)对象引用R(B)对象时，通知GC系统记录这种引用关系

**使用场景**:
- 对象赋值时自动调用
- 确保GC正确跟踪引用关系
- 防止过早回收被引用的对象

### 2. 引用计数管理指令

#### `OP_GC_INC_REF`
- **语法**: `GC_INC_REF A`
- **功能**: 增加对象引用计数
- **操作**: `IncRef(R(A))`
- **说明**: 对GC管理的对象增加引用计数

#### `OP_GC_DEC_REF`
- **语法**: `GC_DEC_REF A`
- **功能**: 减少对象引用计数
- **操作**: `DecRef(R(A))`
- **说明**: 对GC管理的对象减少引用计数，可能触发对象回收

**使用场景**:
- 变量赋值时管理引用计数
- 函数参数传递时调整引用
- 变量生命周期结束时清理引用

### 3. 对象分配指令

#### `OP_GC_ALLOC`
- **语法**: `GC_ALLOC A B`
- **功能**: 分配GC管理的对象
- **操作**: `R(A) := GCAlloc(type=B)`
- **说明**: 分配指定类型的GC对象到寄存器A

**支持的对象类型**:
- `ValueGCTypeString` (2): 字符串对象
- `ValueGCTypeArray` (6): 数组对象
- 其他类型将来扩展

### 4. GC控制指令

#### `OP_GC_COLLECT`
- **语法**: `GC_COLLECT`
- **功能**: 触发垃圾回收
- **操作**: `TriggerGC()`
- **说明**: 强制执行一次完整的垃圾回收

#### `OP_GC_CHECK`
- **语法**: `GC_CHECK A`
- **功能**: 检查对象有效性
- **操作**: `R(A) := IsValidPtr(R(A))`
- **说明**: 检查R(A)是否为有效的GC管理对象

### 5. 对象固定指令

#### `OP_GC_PIN`
- **语法**: `GC_PIN A`
- **功能**: 固定对象防止移动
- **操作**: `Pin(R(A))`
- **说明**: 标记对象为固定状态，防止GC期间移动

#### `OP_GC_UNPIN`
- **语法**: `GC_UNPIN A`
- **功能**: 取消对象固定
- **操作**: `Unpin(R(A))`
- **说明**: 取消对象的固定状态，允许GC移动

**使用场景**:
- 与外部系统交互时固定对象
- 确保指针在C互操作期间有效
- 优化性能敏感的代码路径

### 6. 弱引用指令

#### `OP_WEAK_REF`
- **语法**: `WEAK_REF A B`
- **功能**: 创建弱引用
- **操作**: `R(A) := WeakRef(R(B))`
- **说明**: 创建指向R(B)的弱引用，存储到R(A)

#### `OP_WEAK_GET`
- **语法**: `WEAK_GET A B`
- **功能**: 获取弱引用目标
- **操作**: `R(A) := WeakGet(R(B))`
- **说明**: 获取弱引用R(B)的目标对象，如果已回收则返回nil

**弱引用特性**:
- 不阻止目标对象被回收
- 访问时自动检查目标是否还存活
- 避免循环引用导致的内存泄漏

## 指令使用示例

### 基本GC操作
```assembly
GC_ALLOC 0 2        ; 分配字符串到R0
GC_INC_REF 0        ; 增加R0引用计数
GC_DEC_REF 0        ; 减少R0引用计数
GC_COLLECT          ; 触发GC
```

### 写屏障示例
```assembly
GC_ALLOC 0 2        ; 分配字符串对象到R0
GC_ALLOC 1 6        ; 分配数组对象到R1
GC_WRITE_BARRIER 1 0 ; 记录R1引用R0的关系
```

### 弱引用示例
```assembly
GC_ALLOC 0 2        ; 分配对象到R0
WEAK_REF 1 0        ; 创建R0的弱引用到R1
WEAK_GET 2 1        ; 获取弱引用目标到R2
```

### 对象固定示例
```assembly
GC_ALLOC 0 6        ; 分配数组到R0
GC_PIN 0            ; 固定R0对象
; ... 执行关键操作 ...
GC_UNPIN 0          ; 取消固定R0
```

## 性能考虑

### 指令开销
- **低开销**: `GC_INC_REF`, `GC_DEC_REF`, `GC_CHECK`
- **中等开销**: `GC_WRITE_BARRIER`, `GC_PIN`, `GC_UNPIN`
- **高开销**: `GC_ALLOC`, `GC_COLLECT`

### 优化建议
1. **批量操作**: 尽量批量处理引用计数操作
2. **延迟GC**: 避免频繁调用`GC_COLLECT`
3. **弱引用**: 对于缓存和观察者模式使用弱引用
4. **对象固定**: 仅在必要时使用，及时取消固定

## GC策略集成

### 95% 引用计数 + 5% 标记清除
- 大部分对象通过引用计数即时回收
- 循环引用对象通过标记清除处理
- 写屏障确保引用关系正确跟踪

### 自动优化
- VM自动选择最优的GC策略
- 根据对象类型和引用模式调整
- 最小化GC暂停时间

## 测试验证

所有GC指令已通过完整测试：
- ✅ 基本GC指令操作
- ✅ 写屏障功能
- ✅ 弱引用创建和访问
- ✅ 对象固定和取消固定
- ✅ GC有效性检查

## 版本信息
- **版本**: 1.0.0
- **添加时间**: Phase 5 - VM GC集成
- **状态**: 生产就绪
- **测试覆盖率**: 100% 