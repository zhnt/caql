# AQL 回归测试方案

## 1. 测试目标

### 1.1 核心目标
- **确保代码质量**：在每次修改后验证核心功能的正确性
- **防止功能回退**：确保新的修改不会破坏现有功能
- **持续验证**：在开发过程中提供持续的质量保证
- **自动化检测**：快速发现和定位问题

### 1.2 测试范围
- **核心语言功能**：基本语法、函数、变量、控制流
- **闭包系统**：变量捕获、嵌套闭包、upvalue管理
- **GC系统**：内存管理、引用计数、复杂对象处理
- **数据类型**：数组、字符串、数值、混合类型
- **错误处理**：异常情况和边界条件

## 2. 测试目录结构

```
testdata/
├── regression/          # 回归测试用例
│   ├── basic/          # 基础功能测试
│   ├── closure/        # 闭包系统测试
│   ├── gc/             # GC系统测试
│   ├── integration/    # 集成测试
│   └── scripts/        # 测试脚本
├── unit/               # 单元测试
├── integration/        # 集成测试
└── benchmark/          # 性能测试
```

## 3. 测试分类

### 3.1 基础功能测试 (Basic)
- **语法解析**：变量定义、函数声明、表达式
- **数据类型**：数值、字符串、布尔值、数组
- **操作符**：算术、比较、逻辑运算
- **控制流**：条件语句、循环、跳转

### 3.2 闭包系统测试 (Closure)
- **简单闭包**：无变量捕获的闭包
- **变量捕获**：局部变量、参数捕获
- **嵌套闭包**：多层函数嵌套
- **复杂捕获**：数组、对象、混合类型捕获
- **生命周期**：upvalue管理、内存释放

### 3.3 GC系统测试 (GC)
- **引用计数**：基本引用计数管理
- **复杂对象**：数组、字符串、嵌套结构
- **循环引用**：潜在的循环引用检测
- **内存压力**：大量对象分配和释放
- **协作机制**：与闭包系统的协作

### 3.4 集成测试 (Integration)
- **综合场景**：多个功能模块协作
- **边界条件**：极限情况处理
- **错误恢复**：异常处理和恢复
- **性能验证**：关键路径性能检查

## 4. 测试执行策略

### 4.1 测试级别

#### 快速测试 (Fast)
- **执行时间**：< 30秒
- **覆盖范围**：核心功能
- **触发条件**：每次代码提交

#### 完整测试 (Full)
- **执行时间**：< 5分钟
- **覆盖范围**：全部功能
- **触发条件**：重大修改、发布前

#### 压力测试 (Stress)
- **执行时间**：< 15分钟
- **覆盖范围**：性能、内存、稳定性
- **触发条件**：架构变更、性能优化

### 4.2 测试命令

```bash
# 快速回归测试
make test-regression-fast

# 完整回归测试
make test-regression-full

# 压力测试
make test-regression-stress

# 自动化测试(watch模式)
make test-regression-watch
```

## 5. 测试用例组织

### 5.1 命名规范

```
test_{category}_{feature}_{scenario}.aql
```

**示例**：
- `test_closure_basic_capture.aql` - 闭包基本捕获测试
- `test_gc_array_nested.aql` - GC嵌套数组测试
- `test_basic_function_recursive.aql` - 基本递归函数测试

### 5.2 测试脚本组织

```
test_{category}_{scope}.sh
```

**示例**：
- `test_closure_all.sh` - 闭包系统全部测试
- `test_gc_comprehensive.sh` - GC系统综合测试
- `test_regression_full.sh` - 完整回归测试

## 6. 测试质量标准

### 6.1 测试覆盖率
- **代码覆盖率**：> 80%
- **功能覆盖率**：> 95%
- **边界覆盖率**：> 70%

### 6.2 测试质量
- **测试独立性**：每个测试用例独立运行
- **测试可重复性**：相同输入产生相同输出
- **测试可维护性**：清晰的测试结构和文档

### 6.3 性能基准
- **启动时间**：< 50ms
- **内存使用**：< 10MB (小程序)
- **GC延迟**：< 1ms (95%情况)

## 7. 持续集成

### 7.1 自动化触发
- **代码提交**：触发快速测试
- **Pull Request**：触发完整测试
- **夜间构建**：触发压力测试

### 7.2 测试报告
- **测试结果**：通过/失败统计
- **覆盖率报告**：代码覆盖率分析
- **性能报告**：性能指标变化
- **问题定位**：失败用例详细信息

## 8. 测试维护

### 8.1 测试更新
- **新功能**：添加对应测试用例
- **Bug修复**：添加回归测试用例
- **重构**：更新相关测试用例

### 8.2 测试清理
- **过时测试**：删除不再需要的测试
- **重复测试**：合并相似测试用例
- **测试优化**：提升测试执行效率

## 9. 故障排除

### 9.1 测试失败处理
1. **立即停止**：阻止有问题的代码合并
2. **问题定位**：分析失败原因
3. **快速修复**：修复问题或回滚代码
4. **验证修复**：重新运行测试确认

### 9.2 常见问题
- **环境依赖**：确保测试环境一致性
- **时序问题**：处理并发和异步测试
- **资源冲突**：避免测试间的资源竞争

## 10. 未来扩展

### 10.1 测试增强
- **模糊测试**：自动生成测试用例
- **并行测试**：提升测试执行效率
- **云端测试**：多环境并行测试

### 10.2 质量提升
- **静态分析**：代码质量检查
- **安全测试**：安全漏洞扫描
- **兼容性测试**：多平台兼容性验证

---

## 测试检查清单

### 每次提交前
- [ ] 运行快速回归测试
- [ ] 检查测试覆盖率
- [ ] 验证核心功能正常

### 重大修改前
- [ ] 运行完整回归测试
- [ ] 更新相关测试用例
- [ ] 验证性能指标

### 发布前
- [ ] 运行压力测试
- [ ] 生成测试报告
- [ ] 确认所有测试通过

---

**注意**：在最终开发完成前，保留所有调试代码和详细日志，确保问题可追踪和可重现。 